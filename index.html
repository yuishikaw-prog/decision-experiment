<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¢ãƒ‘ãƒ¼ãƒˆé¸æŠå®Ÿé¨“</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 800px;
            width: 100%;
            padding: 40px;
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
            text-align: center;
        }

        .subtitle {
            color: #666;
            text-align: center;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
            margin-top: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-group {
            display: grid;
            gap: 15px;
            margin-top: 30px;
        }

        .feature-display {
            background: #f8f9fa;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .apartment-name {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 20px;
        }

        .feature-text {
            font-size: 20px;
            color: #333;
            line-height: 1.6;
        }

        .dimension {
            font-weight: bold;
            color: #764ba2;
            margin-bottom: 5px;
        }

        .progress {
            background: #e9ecef;
            height: 8px;
            border-radius: 4px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-bar {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            transition: width 0.3s ease;
        }

        .timer {
            text-align: center;
            font-size: 48px;
            font-weight: bold;
            color: #667eea;
            margin: 40px 0;
        }

        .instruction {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            color: #856404;
        }

        .apartment-choice {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 30px;
        }

        .apartment-btn {
            padding: 30px;
            font-size: 24px;
            font-weight: bold;
        }

        textarea {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            margin-top: 15px;
        }

        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .nback-game {
            text-align: center;
        }

        .nback-number {
            font-size: 72px;
            font-weight: bold;
            color: #667eea;
            margin: 40px 0;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nback-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 30px;
        }

        .result-box {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin-top: 30px;
        }

        .result-item {
            padding: 15px 0;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .result-label {
            font-weight: bold;
            color: #666;
        }

        .result-value {
            color: #333;
            font-weight: bold;
        }

        .btn-primary {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            font-size: 18px;
            font-weight: bold;
        }

        .btn-secondary {
            background: #6c757d;
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 24px;
            }

            .apartment-choice {
                grid-template-columns: 1fr;
            }

            .feature-text {
                font-size: 18px;
            }

            .apartment-name {
                font-size: 28px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Welcome Screen -->
        <div id="welcomeScreen" class="screen active">
            <h1>ã‚¢ãƒ‘ãƒ¼ãƒˆé¸æŠå®Ÿé¨“ã¸ã‚ˆã†ã“ã</h1>
            <p class="subtitle">Dijksterhuis (2004) ã®è¿½è©¦å®Ÿé¨“</p>
            
            <div class="instruction">
                <strong>å®Ÿé¨“ã®æµã‚Œï¼š</strong><br>
                1. 4ã¤ã®ã‚¢ãƒ‘ãƒ¼ãƒˆï¼ˆAã€Bã€Cã€Dï¼‰ã®ç‰¹å¾´ã‚’è¦‹ã¦ã„ãŸã ãã¾ã™<br>
                2. å„ã‚¢ãƒ‘ãƒ¼ãƒˆã«ã¯12å€‹ã®ç‰¹å¾´ãŒã‚ã‚Šã¾ã™ï¼ˆåˆè¨ˆ48è¦ç´ ï¼‰<br>
                3. ã™ã¹ã¦ã®ç‰¹å¾´ã‚’è¦‹ãŸå¾Œã€æœ€é©ãªã‚¢ãƒ‘ãƒ¼ãƒˆã‚’é¸ã‚“ã§ã„ãŸã ãã¾ã™<br>
                4. æœ€å¾Œã«Google Formã§å›ç­”ã‚’é€ä¿¡ã—ã¦ã„ãŸã ãã¾ã™
            </div>

            <div class="btn-group">
                <button class="btn" onclick="selectCondition('immediate')">
                    æ¡ä»¶1: Immediateï¼ˆå³æ™‚åˆ¤æ–­ï¼‰<br>
                    <small>ã™ã¹ã¦ã®æƒ…å ±ã‚’è¦‹ãŸç›´å¾Œã«åˆ¤æ–­</small>
                </button>
                <button class="btn" onclick="selectCondition('conscious')">
                    æ¡ä»¶2: Consciousï¼ˆç†Ÿè€ƒï¼‰<br>
                    <small>3åˆ†é–“ã˜ã£ãã‚Šè€ƒãˆã¦ã‹ã‚‰åˆ¤æ–­</small>
                </button>
                <button class="btn" onclick="selectCondition('unconscious')">
                    æ¡ä»¶3: Unconsciousï¼ˆæ°—æ™´ã‚‰ã—èª²é¡Œï¼‰<br>
                    <small>3åˆ†é–“ã®èª²é¡Œã‚’æŒŸã‚“ã§ã‹ã‚‰åˆ¤æ–­</small>
                </button>
            </div>
        </div>

        <!-- Presentation Screen -->
        <div id="presentationScreen" class="screen">
            <h1>ã‚¢ãƒ‘ãƒ¼ãƒˆæƒ…å ±ã®æç¤º</h1>
            <div class="progress">
                <div id="progressBar" class="progress-bar" style="width: 0%"></div>
            </div>
            <p style="text-align: center; color: #666; margin-bottom: 20px;">
                <span id="currentIndex">0</span> / 48
            </p>
            
            <div class="feature-display">
                <div class="apartment-name" id="apartmentName">ã‚¢ãƒ‘ãƒ¼ãƒˆ A</div>
                <div class="dimension" id="dimensionName">é§…è·é›¢</div>
                <div class="feature-text" id="featureText">å¾’æ­©5åˆ†</div>
            </div>
        </div>

        <!-- Conscious Thinking Screen -->
        <div id="consciousScreen" class="screen">
            <h1>ç†Ÿè€ƒæ™‚é–“</h1>
            <p class="subtitle">ã‚¢ãƒ‘ãƒ¼ãƒˆã®ç‰¹å¾´ã«ã¤ã„ã¦è€ƒãˆã¦ãã ã•ã„</p>
            
            <div class="instruction">
                ã“ã‚Œã‹ã‚‰3åˆ†é–“ã€ã©ã®ã‚¢ãƒ‘ãƒ¼ãƒˆãŒæœ€é©ã‹è€ƒãˆã‚‹æ™‚é–“ã§ã™ã€‚<br>
                æ™‚é–“ãŒçµŒéã—ãŸã‚‰è‡ªå‹•çš„ã«æ¬¡ã®ç”»é¢ã«é€²ã¿ã¾ã™ã€‚
            </div>

            <div class="timer" id="consciousTimer">3:00</div>
            
            <p style="text-align: center; color: #666;">
                ã˜ã£ãã‚Šã¨å„ã‚¢ãƒ‘ãƒ¼ãƒˆã®ç‰¹å¾´ã‚’æ€ã„å‡ºã—ã€æ¯”è¼ƒæ¤œè¨ã—ã¦ãã ã•ã„ã€‚
            </p>
        </div>

        <!-- Unconscious (N-back) Screen -->
        <div id="unconsciousScreen" class="screen">
            <h1>æ•°å­—è¨˜æ†¶èª²é¡Œ</h1>
            <p class="subtitle">æ°—æ™´ã‚‰ã—èª²é¡Œï¼ˆ3åˆ†é–“ï¼‰</p>
            
            <div class="instruction">
                ç”»é¢ã«è¡¨ç¤ºã•ã‚Œã‚‹æ•°å­—ã‚’è¦šãˆã¦ãã ã•ã„ã€‚<br>
                ç¾åœ¨ã®æ•°å­—ãŒ<strong>2ã¤å‰</strong>ã®æ•°å­—ã¨åŒã˜ãªã‚‰ã€ŒåŒã˜ã€ã‚’ã€é•ã†ãªã‚‰ã€Œé•ã†ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚
            </div>

            <div class="timer" id="unconsciousTimer">3:00</div>

            <div class="nback-game">
                <div class="nback-number" id="nbackNumber">-</div>
                <div class="nback-buttons">
                    <button class="btn" onclick="nbackResponse(true)">åŒã˜</button>
                    <button class="btn" onclick="nbackResponse(false)">é•ã†</button>
                </div>
                <p style="margin-top: 20px; color: #666;">
                    æ­£è§£æ•°: <span id="nbackScore">0</span>
                </p>
            </div>
        </div>

        <!-- Selection Screen -->
        <div id="selectionScreen" class="screen">
            <h1>ã‚¢ãƒ‘ãƒ¼ãƒˆã®é¸æŠ</h1>
            <p class="subtitle">æœ€é©ã ã¨æ€ã†ã‚¢ãƒ‘ãƒ¼ãƒˆã‚’é¸ã‚“ã§ãã ã•ã„</p>
            
            <div class="instruction">
                4ã¤ã®ã‚¢ãƒ‘ãƒ¼ãƒˆã®ä¸­ã‹ã‚‰ã€æœ€ã‚‚ä½ã¿ãŸã„ã¨æ€ã†ã‚¢ãƒ‘ãƒ¼ãƒˆã‚’1ã¤é¸ã‚“ã§ãã ã•ã„ã€‚
            </div>

            <div class="apartment-choice">
                <button class="btn apartment-btn" onclick="selectApartment('A')">ã‚¢ãƒ‘ãƒ¼ãƒˆ A</button>
                <button class="btn apartment-btn" onclick="selectApartment('B')">ã‚¢ãƒ‘ãƒ¼ãƒˆ B</button>
                <button class="btn apartment-btn" onclick="selectApartment('C')">ã‚¢ãƒ‘ãƒ¼ãƒˆ C</button>
                <button class="btn apartment-btn" onclick="selectApartment('D')">ã‚¢ãƒ‘ãƒ¼ãƒˆ D</button>
            </div>
        </div>

        <!-- Reason Screen -->
        <div id="reasonScreen" class="screen">
            <h1>åˆ¤æ–­ç†ç”±ã®è¨˜å…¥</h1>
            <p class="subtitle">ãªãœãã®ã‚¢ãƒ‘ãƒ¼ãƒˆã‚’é¸ã³ã¾ã—ãŸã‹ï¼Ÿ</p>
            
            <p style="margin: 20px 0; color: #666;">
                é¸æŠã—ãŸã‚¢ãƒ‘ãƒ¼ãƒˆ: <strong style="color: #667eea; font-size: 24px;" id="selectedApartmentDisplay">-</strong>
            </p>

            <textarea id="reasonText" placeholder="é¸ã‚“ã ç†ç”±ã‚’è‡ªç”±ã«è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚&#10;ä¾‹ï¼šé§…ãŒè¿‘ãã¦ä¾¿åˆ©ã ã‹ã‚‰ã€å®¶è³ƒãŒå®‰ã„ã‹ã‚‰ã€ãªã©"></textarea>

            <button class="btn" onclick="submitReason()">æ¬¡ã¸</button>
        </div>

        <!-- Result Screen -->
        <div id="resultScreen" class="screen">
            <h1>å®Ÿé¨“å®Œäº†</h1>
            <p class="subtitle">æœ€å¾Œã«Google Formã§å›ç­”ã‚’é€ä¿¡ã—ã¦ãã ã•ã„</p>
            
            <div class="result-box">
                <div class="result-item">
                    <span class="result-label">å‚åŠ è€…ID:</span>
                    <span class="result-value" id="resultParticipantId">-</span>
                </div>
                <div class="result-item">
                    <span class="result-label">å®Ÿé¨“æ¡ä»¶:</span>
                    <span class="result-value" id="resultCondition">-</span>
                </div>
                <div class="result-item">
                    <span class="result-label">é¸æŠã—ãŸã‚¢ãƒ‘ãƒ¼ãƒˆ:</span>
                    <span class="result-value" id="resultApartment">-</span>
                </div>
                <div class="result-item">
                    <span class="result-label">æ‰€è¦æ™‚é–“:</span>
                    <span class="result-value" id="resultTime">-</span>
                </div>
            </div>

            <div class="instruction" style="margin-top: 30px; background: #d1ecf1; border-color: #0c5460; color: #0c5460;">
                <strong>é‡è¦ï¼š</strong>ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦Google Formã§å›ç­”ã‚’é€ä¿¡ã—ã¦ãã ã•ã„ã€‚<br>
                å‚åŠ è€…IDã‚„æ¡ä»¶ã¯è‡ªå‹•å…¥åŠ›ã•ã‚Œã¾ã™ã€‚
            </div>

            <button class="btn btn-primary" onclick="openGoogleForm()">
                ğŸ“ Google Formã§å›ç­”ã‚’é€ä¿¡
            </button>
            
            <button class="btn btn-secondary" onclick="location.reload()">
                æœ€åˆã«æˆ»ã‚‹
            </button>
        </div>
    </div>

    <script>
        // Google Form configuration
        const GOOGLE_FORM_BASE_URL = 'https://docs.google.com/forms/d/e/1FAIpQLSc0Id68V07tDtmwGdmjP6YXFlMh66uCpI3-a-vp6EXvTsPVgw/viewform';
        const FORM_ENTRIES = {
            participantId: 'entry.549115285',
            condition: 'entry.520631592',
            apartment: 'entry.685617715',
            reason: 'entry.11330204'
        };

        // Apartment data with 12 features each
        const apartments = {
            'A': [
                { dimension: 'é§…è·é›¢', feature: 'å¾’æ­©5åˆ†', valence: '+' },
                { dimension: 'é¨’éŸ³', feature: 'ã¨ã¦ã‚‚é™ã‹', valence: '+' },
                { dimension: 'æ—¥å½“ãŸã‚Š', feature: 'ã¨ã¦ã‚‚è‰¯ã„', valence: '+' },
                { dimension: 'å°‚æœ‰é¢ç©', feature: '55ã¡ï¼ˆåºƒã„ï¼‰', valence: '+' },
                { dimension: 'å®¶è³ƒ', feature: 'ç›¸å ´ã‚ˆã‚Šã‚„ã‚„å®‰ã„', valence: '+' },
                { dimension: 'ç¯‰å¹´æ•°', feature: '20å¹´ï¼ˆç®¡ç†è‰¯å¥½ï¼‰', valence: '-' },
                { dimension: 'é˜²çŠ¯', feature: 'ã‚ªãƒ¼ãƒˆãƒ­ãƒƒã‚¯ï¼‹ã‚«ãƒ¡ãƒ©', valence: '+' },
                { dimension: 'è²·ã„ç‰©', feature: 'ã‚¹ãƒ¼ãƒ‘ãƒ¼å¾’æ­©2åˆ†', valence: '+' },
                { dimension: 'æ²»å®‰', feature: 'ã¨ã¦ã‚‚å®‰å…¨', valence: '+' },
                { dimension: 'åç´', feature: 'åç´ãŒå°‘ãªã„', valence: '-' },
                { dimension: 'ã‚¨ãƒ¬ãƒ™ãƒ¼ã‚¿ãƒ¼', feature: 'ãªã—ï¼ˆä½å±¤éšï¼‰', valence: '-' },
                { dimension: 'ãƒãƒƒãƒˆ', feature: 'é€Ÿåº¦ãŒä¸å®‰å®š', valence: '-' }
            ],
            'B': [
                { dimension: 'é§…è·é›¢', feature: 'å¾’æ­©10åˆ†', valence: '+' },
                { dimension: 'é¨’éŸ³', feature: 'äº¤é€šéŸ³ã‚„ã‚„æ°—ã«ãªã‚‹', valence: '-' },
                { dimension: 'æ—¥å½“ãŸã‚Š', feature: 'è‰¯ã„', valence: '+' },
                { dimension: 'å°‚æœ‰é¢ç©', feature: '40ã¡ï¼ˆã‚„ã‚„ç‹­ã„ï¼‰', valence: '-' },
                { dimension: 'å®¶è³ƒ', feature: 'å®‰ã„', valence: '+' },
                { dimension: 'ç¯‰å¹´æ•°', feature: '30å¹´', valence: '-' },
                { dimension: 'é˜²çŠ¯', feature: 'ã‚ªãƒ¼ãƒˆãƒ­ãƒƒã‚¯ã®ã¿', valence: '+' },
                { dimension: 'è²·ã„ç‰©', feature: 'ã‚¹ãƒ¼ãƒ‘ãƒ¼å¾’æ­©10åˆ†', valence: '-' },
                { dimension: 'æ²»å®‰', feature: 'å¹³å‡çš„', valence: '-' },
                { dimension: 'åç´', feature: 'ååˆ†', valence: '+' },
                { dimension: 'ã‚¨ãƒ¬ãƒ™ãƒ¼ã‚¿ãƒ¼', feature: 'ã‚ã‚Š', valence: '+' },
                { dimension: 'ãƒãƒƒãƒˆ', feature: 'æ™‚ã€…é…ã„', valence: '-' }
            ],
            'C': [
                { dimension: 'é§…è·é›¢', feature: 'å¾’æ­©18åˆ†', valence: '-' },
                { dimension: 'é¨’éŸ³', feature: 'å¤œé–“ã¯é™ã‹', valence: '+' },
                { dimension: 'æ—¥å½“ãŸã‚Š', feature: 'ã‚„ã‚„æ‚ªã„', valence: '-' },
                { dimension: 'å°‚æœ‰é¢ç©', feature: '45ã¡ï¼ˆã‚„ã‚„ç‹­ã„ï¼‰', valence: '-' },
                { dimension: 'å®¶è³ƒ', feature: 'ç›¸å ´ä¸¦ã¿', valence: '+' },
                { dimension: 'ç¯‰å¹´æ•°', feature: '8å¹´ï¼ˆç¯‰æµ…ï¼‰', valence: '+' },
                { dimension: 'é˜²çŠ¯', feature: 'ã‚«ãƒ¡ãƒ©ã®ã¿', valence: '-' },
                { dimension: 'è²·ã„ç‰©', feature: 'ã‚¹ãƒ¼ãƒ‘ãƒ¼å¾’æ­©3åˆ†', valence: '+' },
                { dimension: 'æ²»å®‰', feature: 'å®‰å…¨', valence: '+' },
                { dimension: 'åç´', feature: 'å°‘ãªã„', valence: '-' },
                { dimension: 'ã‚¨ãƒ¬ãƒ™ãƒ¼ã‚¿ãƒ¼', feature: 'ãªã—', valence: '-' },
                { dimension: 'ãƒãƒƒãƒˆ', feature: 'é«˜é€Ÿå…‰å›ç·š', valence: '+' }
            ],
            'D': [
                { dimension: 'é§…è·é›¢', feature: 'å¾’æ­©25åˆ†', valence: '-' },
                { dimension: 'é¨’éŸ³', feature: 'ã¨ã¦ã‚‚é¨’ãŒã—ã„', valence: '-' },
                { dimension: 'æ—¥å½“ãŸã‚Š', feature: 'æ‚ªã„', valence: '-' },
                { dimension: 'å°‚æœ‰é¢ç©', feature: '35ã¡ï¼ˆç‹­ã„ï¼‰', valence: '-' },
                { dimension: 'å®¶è³ƒ', feature: 'é«˜ã„', valence: '-' },
                { dimension: 'ç¯‰å¹´æ•°', feature: '40å¹´ï¼ˆè€æœ½ï¼‰', valence: '-' },
                { dimension: 'é˜²çŠ¯', feature: 'å…±ç”¨éµã®ã¿', valence: '-' },
                { dimension: 'è²·ã„ç‰©', feature: 'ã‚³ãƒ³ãƒ“ãƒ‹å¾’æ­©1åˆ†', valence: '+' },
                { dimension: 'æ²»å®‰', feature: 'äº‹ä»¶å ±å‘Šã‚ã‚Š', valence: '-' },
                { dimension: 'åç´', feature: 'ã¨ã¦ã‚‚å¤šã„', valence: '+' },
                { dimension: 'ã‚¨ãƒ¬ãƒ™ãƒ¼ã‚¿ãƒ¼', feature: 'ã‚ã‚Š', valence: '+' },
                { dimension: 'ãƒãƒƒãƒˆ', feature: 'é«˜é€Ÿå…‰å›ç·š', valence: '+' }
            ]
        };

        // State variables
        let currentCondition = '';
        let presentationOrder = [];
        let currentPresentationIndex = 0;
        let startTime = 0;
        let selectedApartment = '';
        let participantId = '';
        let reasonText = '';
        let nbackSequence = [];
        let nbackIndex = 0;
        let nbackScore = 0;
        let consciousInterval = null;
        let unconsciousInterval = null;
        let nbackInterval = null;

        // Generate random participant ID
        function generateParticipantId() {
            return 'P' + Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }

        // Shuffle array
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // Create presentation order
        function createPresentationOrder() {
            const allFeatures = [];
            for (const apt in apartments) {
                apartments[apt].forEach(feature => {
                    allFeatures.push({
                        apartment: apt,
                        ...feature
                    });
                });
            }
            return shuffleArray(allFeatures);
        }

        // Show screen
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        // Select condition
        function selectCondition(condition) {
            currentCondition = condition;
            participantId = generateParticipantId();
            presentationOrder = createPresentationOrder();
            currentPresentationIndex = 0;
            startTime = Date.now();
            
            showScreen('presentationScreen');
            presentNextFeature();
        }

        // Present next feature
        function presentNextFeature() {
            if (currentPresentationIndex >= presentationOrder.length) {
                handlePresentationComplete();
                return;
            }

            const feature = presentationOrder[currentPresentationIndex];
            document.getElementById('apartmentName').textContent = `ã‚¢ãƒ‘ãƒ¼ãƒˆ ${feature.apartment}`;
            document.getElementById('dimensionName').textContent = feature.dimension;
            document.getElementById('featureText').textContent = feature.feature;
            
            const progress = ((currentPresentationIndex + 1) / presentationOrder.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('currentIndex').textContent = currentPresentationIndex + 1;

            currentPresentationIndex++;
            setTimeout(presentNextFeature, 3000);
        }

        // Handle presentation complete
        function handlePresentationComplete() {
            if (currentCondition === 'immediate') {
                showScreen('selectionScreen');
            } else if (currentCondition === 'conscious') {
                showScreen('consciousScreen');
                startConsciousTimer();
            } else if (currentCondition === 'unconscious') {
                showScreen('unconsciousScreen');
                startUnconscious();
            }
        }

        // Start conscious timer
        function startConsciousTimer() {
            let timeLeft = 180;
            updateTimerDisplay('consciousTimer', timeLeft);

            consciousInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay('consciousTimer', timeLeft);
                
                if (timeLeft <= 0) {
                    clearInterval(consciousInterval);
                    showScreen('selectionScreen');
                }
            }, 1000);
        }

        // Start unconscious condition
        function startUnconscious() {
            nbackSequence = [];
            nbackIndex = 0;
            nbackScore = 0;
            
            for (let i = 0; i < 60; i++) {
                nbackSequence.push(Math.floor(Math.random() * 9) + 1);
            }

            let timeLeft = 180;
            updateTimerDisplay('unconsciousTimer', timeLeft);

            unconsciousInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay('unconsciousTimer', timeLeft);
                
                if (timeLeft <= 0) {
                    clearInterval(unconsciousInterval);
                    clearInterval(nbackInterval);
                    showScreen('selectionScreen');
                }
            }, 1000);

            showNextNback();
        }

        // Show next n-back number
        function showNextNback() {
            if (nbackIndex >= nbackSequence.length) {
                return;
            }

            document.getElementById('nbackNumber').textContent = nbackSequence[nbackIndex];
            nbackIndex++;

            nbackInterval = setTimeout(showNextNback, 3000);
        }

        // N-back response
        function nbackResponse(isSame) {
            if (nbackIndex < 3) return;

            const current = nbackSequence[nbackIndex - 1];
            const twoBack = nbackSequence[nbackIndex - 3];
            const correct = (isSame && current === twoBack) || (!isSame && current !== twoBack);

            if (correct) {
                nbackScore++;
                document.getElementById('nbackScore').textContent = nbackScore;
            }
        }

        // Update timer display
        function updateTimerDisplay(elementId, seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            document.getElementById(elementId).textContent = 
                `${minutes}:${secs.toString().padStart(2, '0')}`;
        }

        // Select apartment
        function selectApartment(apartment) {
            selectedApartment = apartment;
            document.getElementById('selectedApartmentDisplay').textContent = `ã‚¢ãƒ‘ãƒ¼ãƒˆ ${apartment}`;
            showScreen('reasonScreen');
        }

        // Submit reason
        function submitReason() {
            reasonText = document.getElementById('reasonText').value;
            const endTime = Date.now();
            const totalTime = Math.round((endTime - startTime) / 1000);

            // Display results
            document.getElementById('resultParticipantId').textContent = participantId;
            document.getElementById('resultCondition').textContent = getConditionName(currentCondition);
            document.getElementById('resultApartment').textContent = `ã‚¢ãƒ‘ãƒ¼ãƒˆ ${selectedApartment}`;
            document.getElementById('resultTime').textContent = `${totalTime}ç§’`;

            showScreen('resultScreen');
        }

        // Get condition name
        function getConditionName(condition) {
            const names = {
                'immediate': 'Immediateï¼ˆå³æ™‚åˆ¤æ–­ï¼‰',
                'conscious': 'Consciousï¼ˆç†Ÿè€ƒï¼‰',
                'unconscious': 'Unconsciousï¼ˆæ°—æ™´ã‚‰ã—èª²é¡Œï¼‰'
            };
            return names[condition] || condition;
        }

        // Open Google Form with pre-filled data
        function openGoogleForm() {
            const params = new URLSearchParams({
                'usp': 'pp_url',
                [FORM_ENTRIES.participantId]: participantId,
                [FORM_ENTRIES.condition]: getConditionName(currentCondition),
                [FORM_ENTRIES.apartment]: `ã‚¢ãƒ‘ãƒ¼ãƒˆ ${selectedApartment}`,
                [FORM_ENTRIES.reason]: reasonText
            });

            const formUrl = `${GOOGLE_FORM_BASE_URL}?${params.toString()}`;
            window.open(formUrl, '_blank');
        }
    </script>
</body>
</html>
